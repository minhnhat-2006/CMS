@model IEnumerable<CMS.Models.NavigationMenu>
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    var currentPath = HttpContextAccessor.HttpContext?.Request.Path.Value?.ToLower() ?? "";
}

@if (Model != null && Model.Any())
{
    foreach (var item in Model.OrderBy(x => x.DisplayOrder))
    {
        string menuUrl = item.Url;

        // BẢN LỀ QUYẾT ĐỊNH: Chỉ khi URL là "#" thì mới lấy Link Bài Viết
        if (menuUrl == "#" && item.ContentPageId.HasValue && item.LinkedPage != null)
        {
            menuUrl = $"/bai-viet/{item.LinkedPage.Id}/{item.LinkedPage.Slug}";
        }
        else if (string.IsNullOrEmpty(menuUrl))
        {
            menuUrl = "#";
        }

        string activeClass = (menuUrl != "#" && currentPath.Contains(menuUrl.ToLower())) ? "active fw-bold text-primary" : "";
        bool hasChildren = item.Children != null && item.Children.Any(c => c.IsVisible);

        if (hasChildren)
        {
            <li class="nav-item dropdown custom-hover-dropdown">

                <a class="nav-link text-uppercase @activeClass" href="@menuUrl" id="menu_@item.Id">
                    @item.Name <i class="bi bi-chevron-down ms-1" style="font-size: 0.8rem;"></i>
                </a>

                <ul class="dropdown-menu shadow border-0" aria-labelledby="menu_@item.Id">
                    @foreach (var child in item.Children?.Where(c => c.IsVisible).OrderBy(c => c.DisplayOrder) ?? Enumerable.Empty<CMS.Models.NavigationMenu>())
                    {
                        string childUrl = child.Url;

                        // BẢN LỀ QUYẾT ĐỊNH CHO MỤC CON: Dấu "#" = Bài viết
                        if (childUrl == "#" && child.ContentPageId.HasValue && child.LinkedPage != null)
                        {
                            childUrl = $"/bai-viet/{child.LinkedPage.Id}/{child.LinkedPage.Slug}";
                        }
                        else if (string.IsNullOrEmpty(childUrl))
                        {
                            childUrl = "#";
                        }

                        string childActive = (childUrl != "#" && currentPath.Contains(childUrl.ToLower())) ? "active bg-primary text-white fw-bold" : "";

                        <li>
                            <a class="dropdown-item @childActive" href="@childUrl">@child.Name</a>
                        </li>
                    }
                </ul>
            </li>
        }
        else
        {
            <li class="nav-item">
                <a class="nav-link text-uppercase @activeClass" href="@menuUrl">
                    @item.Name
                </a>
            </li>
        }
    }
}